

# 定义

- 由一组dml语句组成，该组dml语句要么全部成功，要么全部失败，用以保证数据的一致性



# ACID特性

1. 原子性(Atomicity)
   - 事务是一个不可分隔的工作单位，事务中的操作要么都执行，要么都不执行
2. 一致性(Consistency)
   - 事务必须使数据库从一致性状态变换到另一个一致性状态
3. 隔离性(Isolation)
   - 事务的隔离性是多个用户并发访问数据库时，数据库为每一个用户开启的事务，不能被其他事务的操作数据所干扰，多个并发事务之间要相互隔离
4. 持久性(Durability)
   - 事务的持久性是指一个事务被提交到数据库里面后，它对数据库的改变就是永久的，接下来即使数据库发生故障也不应该对其有任何影响

# 事务和锁

- 当执行事务操作时，MySQL会在表上加锁，防止其他用户更改表的数据



# 重要操作

1. `start transaction`:开始一个事务
2. `savepoint <point name>`:设置保存点
3. `rollback <point name>`:回滚到保存点
4. `rollback`:回退全部事务
5. `commit`:提交事务，所有的操作生效，不能回退



# 细节

1. 不手动开启事务，dml语句会`自动提交`
2. 开始一个事务后没有指定保存点，执行`rollback`会回退到事务开始的状态（相当于开始事务有一个默认保存点）
3. MySQL事务需要innoDB的存储引擎才可以使用，MyISM不支持
4. `set autocommit=off`也可以开始事务



# 隔离

- 多个连接开启各自的事务操作数据库中数据时，数据库系统要负责隔离操作，以保证各个连接在获取数据时的准确性
- 不考虑隔离级别可能会引发：`脏读`，`不可重复读`，`幻读`



## 脏读

- 当一个事务读取另一个事务``尚未提交``的改变（dml）时，产生脏读
  - 读到的数据可能会被rollback



## 不可重复读

- 同一查询在同一事务中多次进行，由于``其他提交事务``所做的`修改`或``删除``，每次返回不同的结果集，此时发生``不可重复读``



# 幻读

- 同一查询在同一事务中多次进行，由于``其他提交事务``所做的`插入`操作，每次返回不同的结果集，此时发生``幻读``



# 隔离级别

- 定义了**事务与事务之间的隔离程度**

- 查询当前会话的隔离级别：`select @@tx_isolation`

- 查询系统当前的隔离级别：`select @@gobal.tx_isolation`

- 设置当前会话隔离级别：

  `set session transaction isolation level <isolation level>`

- 设置系统当前隔离级别：

  `set gobal transaction isolation level <isolation level>`

| MySQL隔离级别（4种）       | 脏读 | 不可重复读 | 幻读 | 加锁读 |
| -------------------------- | ---- | ---------- | ---- | ------ |
| 读未提交(read uncommitted) | ✅    | ✅          | ✅    | 不加锁 |
| 读已提交(read committed)   | ❎    | ✅          | ✅    | 不加锁 |
| 可重复读(repeatable read)  | ❎    | ❎          | ❎    | 不加锁 |
| 可串行化(serializable)     | ❎    | ❎          | ❎    | 加锁   |

